!function(){function e(e){return l+"-"+e}function t(e){return document.getElementById(e)}function n(e,t,n){var a=document.createElement(e);for(var i in n)a[i]=n[i];return t.appendChild(a),a}function a(e,t){var n={type:e};return t&&(n.data=t),n}function i(){var e=p[c];if(e.prepare(),!e.isStart()){u.disable();var t=setInterval(function(){e.isStart()&&(u.enable(),clearInterval(t))},500)}u.player=e}function r(){var t=n("article",document.body,{id:l}),i=n("button",t,{id:e("toggle"),innerHTML:'<span class="fa fa-heart"></span>'});i.onclick=function(){t.classList.toggle("active")};var r=n("input",t,{id:e("local"),type:"text",placeholder:"Peer ID",readOnly:!0});r.onfocus=function(){return this.select(),!1};var o=n("input",t,{id:e("remote"),type:"text",placeholder:"Remote peer ID"}),s=n("button",t,{id:e("connect"),innerHTML:'<span class="fa fa-plug"></span>'});s.onclick=function(){return u.connect(o.value),!1};var c=n("button",t,{id:e("disconnect"),hidden:!0,innerHTML:'<span class="fa fa-close"></span>'});c.onclick=function(){return u.disconnect(),!1};var p=n("button",t,{id:e("play"),innerHTML:'<span class="fa fa-play"></span>',title:"Play"});p.onclick=function(){return u.player.play(),u.remote.send(a("PLAY")),!1};var y=n("button",t,{id:e("pause"),innerHTML:'<span class="fa fa-pause"></span>',title:"Pause"});y.onclick=function(){return u.player.pause(),u.remote.send(a("PAUSE")),!1};var f=n("button",t,{id:e("sync"),innerHTML:'<span class="fa fa-refresh"></span>',title:"Sync with me"});f.onclick=function(){var e=u.player.getTime();return u.player.seek(e),u.remote.send(a("SEEK",e)),!1};var d=n("button",t,{id:e("restart"),innerHTML:'<span class="fa fa-step-backward"></span>',title:"Restart"});d.onclick=function(){return u.player.restart?u.player.restart():u.player.seek(0),u.remote.send(a("SEEK",0)),!1},u.ui={main:t,local:r,remote:o,connect:s,disconnect:c,toggle:i,play:p,pause:y,sync:f,restart:d}}function o(){if(!window.Peer)throw"Cannot initialize peer.";var e=new Peer({key:"kl2e8piw363qsemi",config:{iceServers:[{url:"stun:stun.turnservers.com:3478"},{url:"stun:stun01.sipphone.com"},{url:"stun:stun.ekiga.net"},{url:"stun:stun.fwdnet.net"},{url:"stun:stun.ideasip.com"},{url:"stun:stun.iptel.org"},{url:"stun:stun.rixtelecom.se"},{url:"stun:stun.schlund.de"},{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"},{url:"stun:stunserver.org"},{url:"stun:stun.softjoys.com"},{url:"stun:stun.voiparound.com"},{url:"stun:stun.voipbuster.com"},{url:"stun:stun.voipstunt.com"},{url:"stun:stun.voxgratia.org"},{url:"stun:stun.xten.com"},{url:"turn:numb.viagenie.ca",credential:"muazkh",username:"webrtc@live.com"},{url:"turn:192.158.29.39:3478?transport=udp",credential:"JZEOEt2V3Qb0y27GRntt2u2PAYA=",username:"28224511:1379330808"},{url:"turn:192.158.29.39:3478?transport=tcp",credential:"JZEOEt2V3Qb0y27GRntt2u2PAYA=",username:"28224511:1379330808"}]}});e.on("open",function(e){u.ui.local.value=e}),e.on("connection",s),u.peer=e}function s(e){function t(){o=Date.now(),e.send(a("REQ"))}function n(){e.send(a("CHECK"))}function i(){return location.host+location.pathname}u.connection=e;var r=u.ui;r.remote.value=e.peer,r.remote.disabled=!0,r.connect.hidden=!0,r.disconnect.hidden=!1;var o=0,s=0,l=0,c=0;e.on("data",function(n){var r=u.player;switch(n.type){case"REQ":e.send(a("ACK"));break;case"ACK":l=Date.now()-o,c++,s+=l,console.log(l+"ms"),setTimeout(function(){t(e)},1e3);break;case"CHECK":e.send(a("PATH",i()));break;case"PATH":n.data!==i()&&(console.log("Not on the same page."),e.close());break;case"MSG":console.log("Remote: "+n.data);break;case"SEEK":r.seek(n.data);break;case"PAUSE":r.pause();break;case"PLAY":r.play()}}),t(),n(),e.on("close",function(){r.remote.value="",r.remote.disabled=!1,r.connect.hidden=!1,r.disconnect.hidden=!0,u.connection=null})}var u={},l="coplay";if(!t(l)){var c=location.host.match(/(youku|sohu|tudou|qq|iqiyi|youtube|bilibili).com/);if(c){c=c[1];var p={};p.youku={prepare:function(){},play:function(){PlayerPause(!1)},pause:function(){PlayerPause(!0)},seek:function(e){PlayerSeek(e)},isStart:function(){return playerStart},getTime:function(){return PlayerInfo().time}},p.tudou={prepare:function(){this.player=t("tudouHomePlayer")},play:function(){this.player.notify("play")},pause:function(){this.player.notify("pause")},seek:function(e){this.player.notify("seek",[-86400]),this.player.notify("seek",[e])},restart:function(){this.player.notify("replay")},isStart:function(){return!0},getTime:function(){return this.player.notify("getPlaytime")}},p.qq={prepare:function(){this.player=txv.playdata.player},play:function(){this.player.play()},pause:function(){this.player.pause()},seek:function(e){this.player.setPlaytime(e)},isStart:function(){return this.player.isStartPlay},getTime:function(){return this.player.getPlaytime()}},p.iqiyi={prepare:function(){this.player=t("flash")},play:function(){this.player.resumeQiyiVideo()},pause:function(){this.player.pauseQiyiVideo()},seek:function(e){this.player.seekQiyiVideo(e)},isStart:function(){return!0},getTime:function(){return JSON.parse(this.player.getQiyiPlayerInfo()).currentTime/1e3}},p.sohu={prepare:function(){this.player=t("player")||t("player_ob")},play:function(){this.player.playVideo()},pause:function(){this.player.pauseVideo()},seek:function(e){this.player.seekTo(e)},isStart:function(){return-1!==this.player.getPlayerState()},getTime:function(){return this.player.playedTime()}},p.youtube={prepare:function(){this.player=t("movie_player")},play:function(){this.player.playVideo()},pause:function(){this.player.pauseVideo()},seek:function(e){this.player.seekTo(e,!0)},isStart:function(){return!0},getTime:function(){return this.player.getCurrentTime()}},p.bilibili={prepare:function(){this.player=t("player_placeholder")},play:function(){this.isStart()||this.player.jwPlay()},pause:function(){this.isStart()&&this.player.jwPause()},seek:function(e){this.player.jwSeek(e)},isStart:function(){return"PLAYING"===this.player.jwGetState()},getTime:function(){return this.player.jwGetPosition()}},u.remote={send:function(){var e=u.connection;e&&e.send.apply(e,arguments)}},u.init=function(){var e=t(l);e||(r(),i(),o())},u.setDisabled=function(e){var t=u.ui;t.play.disabled=e,t.pause.disabled=e,t.sync.disabled=e,t.restart.disabled=e},u.enable=function(){u.setDisabled(!1)},u.disable=function(){u.setDisabled(!0)},u.connect=function(e){var t=u.peer.connect(e,{label:"coplay",serialization:"json",reliable:!1});t.on("open",function(){s(t)})},u.disconnect=function(){var e=u.connection;e&&e.close()},window.coplay=u,u.init()}}}();